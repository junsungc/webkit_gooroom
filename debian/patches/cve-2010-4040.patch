Description: fix cve-2010-4040
Author: Michael Gilbert <michael.s.gilbert@gmail.com>
Origin: http://trac.webkit.org/changeset/68446
Index: webkit/WebCore/platform/image-decoders/gif/GIFImageDecoder.cpp
===================================================================
--- webkit.orig/WebCore/platform/image-decoders/gif/GIFImageDecoder.cpp	2010-10-18 20:55:17.000000000 -0400
+++ webkit/WebCore/platform/image-decoders/gif/GIFImageDecoder.cpp	2010-11-14 19:01:51.000000000 -0500
@@ -343,7 +343,8 @@
 
         if ((prevMethod == RGBA32Buffer::DisposeNotSpecified) || (prevMethod == RGBA32Buffer::DisposeKeep)) {
             // Preserve the last frame as the starting state for this frame.
-            buffer->copyBitmapData(*prevBuffer);
+            if (!buffer->copyBitmapData(*prevBuffer))
+                return setFailed();
         } else {
             // We want to clear the previous frame to transparent, without
             // affecting pixels in the image outside of the frame.
@@ -356,7 +357,8 @@
                     return setFailed();
             } else {
               // Copy the whole previous buffer, then clear just its frame.
-              buffer->copyBitmapData(*prevBuffer);
+              if (!buffer->copyBitmapData(*prevBuffer))
+                  return setFailed();
               for (int y = prevRect.y(); y < prevRect.bottom(); ++y) {
                   for (int x = prevRect.x(); x < prevRect.right(); ++x)
                       buffer->setRGBA(x, y, 0, 0, 0, 0);
Index: webkit/WebCore/platform/image-decoders/ImageDecoder.cpp
===================================================================
--- webkit.orig/WebCore/platform/image-decoders/ImageDecoder.cpp	2010-10-18 20:55:17.000000000 -0400
+++ webkit/WebCore/platform/image-decoders/ImageDecoder.cpp	2010-11-14 19:01:51.000000000 -0500
@@ -126,14 +126,15 @@
     m_hasAlpha = true;
 }
 
-void RGBA32Buffer::copyBitmapData(const RGBA32Buffer& other)
+bool RGBA32Buffer::copyBitmapData(const RGBA32Buffer& other)
 {
     if (this == &other)
-        return;
+        return true;
 
     m_bytes = other.m_bytes;
     m_size = other.m_size;
     setHasAlpha(other.m_hasAlpha);
+    return true;
 }
 
 bool RGBA32Buffer::setSize(int newWidth, int newHeight)
Index: webkit/WebCore/platform/image-decoders/ImageDecoder.h
===================================================================
--- webkit.orig/WebCore/platform/image-decoders/ImageDecoder.h	2010-10-18 20:55:17.000000000 -0400
+++ webkit/WebCore/platform/image-decoders/ImageDecoder.h	2010-11-14 19:01:51.000000000 -0500
@@ -83,8 +83,8 @@
         void zeroFill();
 
         // Creates a new copy of the image data in |other|, so the two images
-        // can be modified independently.
-        void copyBitmapData(const RGBA32Buffer& other);
+        // can be modified independently.  Returns whether the copy succeeded.
+        bool copyBitmapData(const RGBA32Buffer& other);
 
         // Copies the pixel data at [(startX, startY), (endX, startY)) to the
         // same X-coordinates on each subsequent row up to but not including
