description: fix cve-2010-1386
author: Michael Gilbert <michael.s.gilbert@gmail.com>
origin: http://trac.webkit.org/changeset/56188
Index: webkit-1.2.1/WebCore/page/Geolocation.cpp
===================================================================
--- webkit-1.2.1.orig/WebCore/page/Geolocation.cpp	2010-06-28 17:07:35.000000000 -0400
+++ webkit-1.2.1/WebCore/page/Geolocation.cpp	2010-06-28 17:11:07.000000000 -0400
@@ -29,7 +29,6 @@
 #include "Geolocation.h"
 
 #include "Chrome.h"
-#include "Document.h"
 #include "Frame.h"
 #include "Page.h"
 #include <wtf/CurrentTime.h>
@@ -232,6 +231,8 @@
 
 Geoposition* Geolocation::lastPosition()
 {
+    ASSERT(isAllowed());
+
 #if ENABLE(CLIENT_BASED_GEOLOCATION)
     if (!m_frame)
         return 0;
@@ -379,22 +380,6 @@
         stopUpdating();
 }
 
-void Geolocation::suspend()
-{
-#if !ENABLE(CLIENT_BASED_GEOLOCATION)
-    if (hasListeners())
-        m_service->suspend();
-#endif
-}
-
-void Geolocation::resume()
-{
-#if !ENABLE(CLIENT_BASED_GEOLOCATION)
-    if (hasListeners())
-        m_service->resume();
-#endif
-}
-
 void Geolocation::setIsAllowed(bool allowed)
 {
     // This may be due to either a new position from the service, or a cached
Index: webkit-1.2.1/WebCore/page/Geolocation.h
===================================================================
--- webkit-1.2.1.orig/WebCore/page/Geolocation.h	2010-06-28 17:07:35.000000000 -0400
+++ webkit-1.2.1/WebCore/page/Geolocation.h	2010-06-28 17:11:31.000000000 -0400
@@ -35,13 +35,6 @@
 #include "PositionErrorCallback.h"
 #include "PositionOptions.h"
 #include "Timer.h"
-#include <wtf/HashMap.h>
-#include <wtf/HashSet.h>
-#include <wtf/OwnPtr.h>
-#include <wtf/PassRefPtr.h>
-#include <wtf/RefCounted.h>
-#include <wtf/RefPtr.h>
-#include <wtf/Vector.h>
 
 namespace WebCore {
 
@@ -60,26 +53,15 @@
 public:
     static PassRefPtr<Geolocation> create(Frame* frame) { return adoptRef(new Geolocation(frame)); }
 
-    virtual ~Geolocation();
+    ~Geolocation();
 
     void disconnectFrame();
     
-    Geoposition* lastPosition();
-
     void getCurrentPosition(PassRefPtr<PositionCallback>, PassRefPtr<PositionErrorCallback>, PassRefPtr<PositionOptions>);
     int watchPosition(PassRefPtr<PositionCallback>, PassRefPtr<PositionErrorCallback>, PassRefPtr<PositionOptions>);
     void clearWatch(int watchId);
 
-    void suspend();
-    void resume();
-
     void setIsAllowed(bool);
-    bool isAllowed() const { return m_allowGeolocation == Yes; }
-    bool isDenied() const { return m_allowGeolocation == No; }
-    
-    void setShouldClearCache(bool shouldClearCache) { m_shouldClearCache = shouldClearCache; }
-    bool shouldClearCache() const { return m_shouldClearCache; }
-    Frame* frame() const { return m_frame; }
 
 #if ENABLE(CLIENT_BASED_GEOLOCATION)
     void setPosition(GeolocationPosition*);
@@ -89,6 +71,11 @@
 #endif
 
 private:
+    Geoposition* lastPosition();
+
+    bool isAllowed() const { return m_allowGeolocation == Yes; }
+    bool isDenied() const { return m_allowGeolocation == No; }
+
     Geolocation(Frame*);
 
     class GeoNotifier : public RefCounted<GeoNotifier> {
Index: webkit-1.2.1/WebCore/page/Geolocation.idl
===================================================================
--- webkit-1.2.1.orig/WebCore/page/Geolocation.idl	2010-06-28 17:11:05.000000000 -0400
+++ webkit-1.2.1/WebCore/page/Geolocation.idl	2010-06-28 17:11:07.000000000 -0400
@@ -26,8 +26,6 @@
 module core {
 
     interface [OmitConstructor] Geolocation {
-        readonly attribute Geoposition lastPosition;
-
         [Custom] void getCurrentPosition(in PositionCallback successCallback, in PositionErrorCallback errorCallback, in PositionOptions options);
 
         [Custom] long watchPosition(in PositionCallback successCallback, in PositionErrorCallback errorCallback, in PositionOptions options);
