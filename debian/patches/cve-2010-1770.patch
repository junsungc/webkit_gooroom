description: fix cve-2010-1770
author: Michael Gilbert <michael.s.gilbert@gmail.com>
origin: http://trac.webkit.org/changeset/59795
Index: webkit-1.2.1/WebCore/rendering/RenderText.cpp
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderText.cpp	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderText.cpp	2010-06-28 22:04:55.000000000 -0400
@@ -203,7 +203,7 @@
 PassRefPtr<StringImpl> RenderText::originalText() const
 {
     Node* e = node();
-    return e ? static_cast<Text*>(e)->dataImpl() : 0;
+    return (e && e->isTextNode()) ? static_cast<Text*>(e)->dataImpl() : 0;
 }
 
 void RenderText::absoluteRects(Vector<IntRect>& rects, int tx, int ty)
Index: webkit-1.2.1/WebCore/rendering/RenderTextFragment.cpp
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderTextFragment.cpp	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderTextFragment.cpp	2010-06-28 22:04:55.000000000 -0400
@@ -47,7 +47,7 @@
 PassRefPtr<StringImpl> RenderTextFragment::originalText() const
 {
     Node* e = node();
-    RefPtr<StringImpl> result = (e ? static_cast<Text*>(e)->dataImpl() : contentString());
+    RefPtr<StringImpl> result = ((e && e->isTextNode()) ? static_cast<Text*>(e)->dataImpl() : contentString());
     if (result && (start() > 0 || start() < result->length()))
         result = result->substring(start(), end());
     return result.release();
@@ -80,7 +80,7 @@
 {
     if (start()) {
         Node* e = node();
-        StringImpl*  original = (e ? static_cast<Text*>(e)->dataImpl() : contentString());
+        StringImpl*  original = ((e && e->isTextNode()) ? static_cast<Text*>(e)->dataImpl() : contentString());
         if (original)
             return (*original)[start() - 1];
     }
