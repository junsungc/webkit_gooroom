description: fix cve-2010-1771
author: Michael Gilbert <michael.s.gilbert@gmail.com>
origin: http://trac.webkit.org/changeset/59876
Index: webkit-1.2.1/WebCore/dom/Element.cpp
===================================================================
--- webkit-1.2.1.orig/WebCore/dom/Element.cpp	2010-06-28 21:51:06.000000000 -0400
+++ webkit-1.2.1/WebCore/dom/Element.cpp	2010-06-28 22:07:40.000000000 -0400
@@ -938,7 +938,7 @@
                 newStyle->setChildrenAffectedByDirectAdjacentRules();
         }
 
-        if (ch != NoChange || pseudoStyleCacheIsInvalid(currentStyle.get(), newStyle.get())) {
+        if (ch != NoChange || pseudoStyleCacheIsInvalid(currentStyle.get(), newStyle.get()) || change == Force && renderer() && renderer()->requiresForcedStyleRecalcPropagation()) {
             setRenderStyle(newStyle);
         } else if (needsStyleRecalc() && (styleChangeType() != SyntheticStyleChange) && (document()->usesSiblingRules() || document()->usesDescendantRules())) {
             // Although no change occurred, we use the new style so that the cousin style sharing code won't get
Index: webkit-1.2.1/WebCore/rendering/RenderMenuList.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderMenuList.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderMenuList.h	2010-06-28 22:07:40.000000000 -0400
@@ -72,6 +72,8 @@
 
     virtual void styleDidChange(StyleDifference, const RenderStyle* oldStyle);
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
     // PopupMenuClient methods
     virtual String itemText(unsigned listIndex) const;
     virtual String itemToolTip(unsigned listIndex) const;
Index: webkit-1.2.1/WebCore/rendering/RenderProgress.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderProgress.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderProgress.h	2010-06-28 22:07:40.000000000 -0400
@@ -50,6 +50,8 @@
 // This will catch anyone doing an unnecessary cast.
 void toRenderProgress(const RenderProgress*);
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
 } // namespace WebCore
 
 #endif
Index: webkit-1.2.1/WebCore/rendering/RenderButton.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderButton.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderButton.h	2010-06-28 22:07:40.000000000 -0400
@@ -57,12 +57,14 @@
 
     virtual bool canHaveChildren() const;
 
-protected:
+private:
     virtual void styleWillChange(StyleDifference, const RenderStyle* newStyle);
     virtual void styleDidChange(StyleDifference, const RenderStyle* oldStyle);
 
     virtual bool hasLineIfEmpty() const { return true; }
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
     void timerFired(Timer<RenderButton>*);
 
     RenderTextFragment* m_buttonText;
Index: webkit-1.2.1/WebCore/rendering/RenderObject.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderObject.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderObject.h	2010-06-28 22:07:40.000000000 -0400
@@ -322,6 +322,8 @@
     bool cellWidthChanged() const { return m_cellWidthChanged; }
     void setCellWidthChanged(bool b = true) { m_cellWidthChanged = b; }
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return false; }
+
 #if ENABLE(MATHML)
     virtual bool isRenderMathMLBlock() const { return false; }
 #endif // ENABLE(MATHML)
@@ -412,7 +414,6 @@
     void drawArcForBoxSide(GraphicsContext*, int x, int y, float thickness, IntSize radius, int angleStart,
                            int angleSpan, BoxSide, Color, EBorderStyle, bool firstCorner);
 
-public:
     // The pseudo element style can be cached or uncached.  Use the cached method if the pseudo element doesn't respect
     // any pseudo classes (and therefore has no concept of changing state).
     RenderStyle* getCachedPseudoStyle(PseudoId, RenderStyle* parentStyle = 0) const;
Index: webkit-1.2.1/WebCore/rendering/RenderSlider.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderSlider.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderSlider.h	2010-06-28 22:07:40.000000000 -0400
@@ -58,6 +58,8 @@
 
         virtual void styleDidChange(StyleDifference, const RenderStyle* oldStyle);
 
+        virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
         PassRefPtr<RenderStyle> createThumbStyle(const RenderStyle* parentStyle);
 
         int trackSize();
Index: webkit-1.2.1/WebCore/rendering/RenderListItem.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderListItem.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderListItem.h	2010-06-28 22:07:40.000000000 -0400
@@ -63,6 +63,8 @@
 
     virtual void styleDidChange(StyleDifference, const RenderStyle* oldStyle);
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
     void updateMarkerLocation();
     inline int calcValue() const;
     void updateValueNow() const;
Index: webkit-1.2.1/WebCore/rendering/RenderMedia.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderMedia.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderMedia.h	2010-06-28 22:07:40.000000000 -0400
@@ -118,6 +118,8 @@
 
     virtual void styleDidChange(StyleDifference, const RenderStyle* oldStyle);
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
     RefPtr<HTMLElement> m_controlsShadowRoot;
     RefPtr<MediaControlElement> m_panel;
     RefPtr<MediaControlMuteButtonElement> m_muteButton;
Index: webkit-1.2.1/WebCore/rendering/RenderDataGrid.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderDataGrid.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderDataGrid.h	2010-06-28 22:07:40.000000000 -0400
@@ -53,6 +53,8 @@
 private:
     virtual void styleDidChange(StyleDifference, const RenderStyle* oldStyle);
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
     RenderStyle* columnStyle(DataGridColumn*);
     RenderStyle* headerStyle(DataGridColumn*);
     void recalcStyleForColumns();
Index: webkit-1.2.1/WebCore/rendering/RenderTextControl.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderTextControl.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderTextControl.h	2010-06-28 22:07:40.000000000 -0400
@@ -107,6 +107,8 @@
 
     virtual bool canBeProgramaticallyScrolled(bool) const { return true; }
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
     String finishText(Vector<UChar>&) const;
 
     bool m_wasChangedSinceLastChangeEvent;
Index: webkit-1.2.1/WebCore/rendering/RenderFileUploadControl.h
===================================================================
--- webkit-1.2.1.orig/WebCore/rendering/RenderFileUploadControl.h	2010-05-13 16:31:30.000000000 -0400
+++ webkit-1.2.1/WebCore/rendering/RenderFileUploadControl.h	2010-06-28 22:07:40.000000000 -0400
@@ -56,6 +56,8 @@
 
     virtual void styleDidChange(StyleDifference, const RenderStyle* oldStyle);
 
+    virtual bool requiresForcedStyleRecalcPropagation() const { return true; }
+
     // FileChooserClient methods.
     void valueChanged();
     void repaint() { RenderBlock::repaint(); }
